'use client'

import { createContext, useContext, useState, useEffect, useCallback, type ReactNode } from 'react'
import type { Language, LanguageCode } from './types'

interface LanguageContextType {
  currentLanguage: LanguageCode
  languages: Language[]
  isRTL: boolean
  setLanguage: (code: LanguageCode) => void
  t: (key: string) => string
}

const defaultLanguages: Language[] = [
  { code: 'fr', name: 'French', native_name: 'Français', is_default: true, is_rtl: false, is_active: true },
  { code: 'ar', name: 'Arabic', native_name: 'العربية', is_default: false, is_rtl: true, is_active: true },
  { code: 'en', name: 'English', native_name: 'English', is_default: false, is_rtl: false, is_active: true },
]

// UI translations for the admin interface
const uiTranslations: Record<LanguageCode, Record<string, string>> = {
  fr: {
    'products': 'Produits',
    'categories': 'Catégories',
    'dashboard': 'Tableau de bord',
    'orders': 'Commandes',
    'settings': 'Paramètres',
    'reports': 'Rapports',
    'add_product': 'Ajouter un produit',
    'edit_product': 'Modifier le produit',
    'save': 'Enregistrer',
    'cancel': 'Annuler',
    'delete': 'Supprimer',
    'search': 'Rechercher',
    'filter': 'Filtrer',
    'name': 'Nom',
    'price': 'Prix',
    'category': 'Catégorie',
    'status': 'Statut',
    'active': 'Actif',
    'inactive': 'Inactif',
    'draft': 'Brouillon',
    'available': 'Disponible',
    'unavailable': 'Indisponible',
    'description': 'Description',
    'short_description': 'Description courte',
    'long_description': 'Description longue',
    'images': 'Images',
    'variants': 'Variantes',
    'details': 'Détails',
    'pricing': 'Tarification',
    'inventory': 'Inventaire',
    'type': 'Type',
    'simple': 'Simple',
    'variable': 'Variable',
    'composite': 'Composite',
    'barcode': 'Code-barres',
    'sku': 'SKU',
    'cost_price': 'Prix de revient',
    'brand': 'Marque',
    'track_stock': 'Suivre le stock',
    'printer_dest': 'Imprimante',
    'kitchen': 'Cuisine',
    'bar': 'Bar',
    'oven': 'Four',
    'none': 'Aucune',
    'all_categories': 'Toutes les catégories',
    'all_statuses': 'Tous les statuts',
    'no_products': 'Aucun produit trouvé',
    'no_categories': 'Aucune catégorie trouvée',
    'loading': 'Chargement...',
    'error': 'Erreur',
    'success': 'Succès',
    'confirm_delete': 'Confirmer la suppression',
    'language': 'Langue',
    'translations': 'Traductions',
    'add_translation': 'Ajouter une traduction',
    'edit_translation': 'Modifier la traduction',
    'unsaved_changes': 'Modifications non enregistrées',
    'unsaved_changes_confirm': 'Vous avez des modifications non enregistrées. Voulez-vous vraiment quitter ?',
    // Dashboard
    'today_revenue': 'Revenus du jour',
    'today_orders': 'Commandes',
    'avg_order': 'Panier moyen',
    'completion_rate': 'Taux de complétion',
    'vs_yesterday': 'vs hier',
    'completed': 'Terminées',
    'pending': 'En attente',
    'cancelled': 'Annulées',
    'refresh': 'Actualiser',
    'performance_today': "Performance d'aujourd'hui pour",
    'your_restaurant': 'votre restaurant',
    // Orders
    'order_number': 'Numéro',
    'date': 'Date',
    'total': 'Total',
    'waiter': 'Serveur',
    'actions': 'Actions',
    'export_csv': 'Exporter CSV',
    'no_orders': 'Aucune commande trouvée',
    'confirmed': 'Confirmé',
    'preparing': 'En préparation',
    'ready': 'Prêt',
    'void': 'Annulé',
    'dine_in': 'Sur place',
    'takeaway': 'À emporter',
    'delivery': 'Livraison',
    'page_of': 'Page {page} sur {total}',
    'clear': 'Effacer',
    // Sidebar
    'collapse': 'Réduire',
    // Header
    'owner': 'Propriétaire',
    'logout': 'Se déconnecter',
    // Settings
    'general_settings': 'Paramètres généraux',
    'store_info': 'Informations du magasin',
    'notifications': 'Notifications',
    'security': 'Sécurité',
    // New product
    'new_product': 'Nouveau produit',
    'create_product': 'Créer un produit',
    'back': 'Retour',
    // Common
    'found': 'trouvé(s)',
    'new_category': 'Nouvelle catégorie',
    'create_category': 'Créer une catégorie',
    'edit_category': 'Modifier la catégorie',
    'parent_category': 'Catégorie parente',
    'no_parent': 'Aucune (catégorie racine)',
    'product_not_found': 'Produit non trouvé',
    'product_variants': 'Variantes du produit',
    'images_updated': 'Images mises à jour',
    'title': 'Titre',
    'select_category': 'Sélectionner une catégorie',
    'cost_per_item': 'Coût par article',
    'margin': 'Marge',
    'profit': 'Profit',
    'track_quantity': 'Suivre la quantité',
    'manage_stock_levels': 'Gérer les niveaux de stock de ce produit',
    'sku_label': 'SKU (Unité de gestion des stocks)',
    'barcode_label': 'Code-barres (ISBN, UPC, GTIN)',
    'brand_supplier': 'Marque / Fournisseur',
    'print_options': "Options d'impression",
    'print_destination': "Destination d'impression",
    'print_destination_help': 'Sélectionnez où les bons de commande seront envoyés',
    'organization': 'Organisation',
    'product_type': 'Type de produit',
    'information': 'Informations',
    'created': 'Créé',
    'modified': 'Modifié',
    'visible_catalog': 'Visible dans le catalogue',
    'not_visible_customers': 'Non visible pour les clients',
    'media': 'Médias',
    'good_description_help': 'Une bonne description aide les clients à comprendre votre produit.',
    'leave_empty_fallback': 'Laissez vide pour utiliser la description en {lang}.',
    'default': 'Défaut',
    // Variants
    'add_variant': 'Ajouter une variante',
    'edit_variant': 'Modifier la variante',
    'delete_variant': 'Supprimer la variante',
    'new_variant': 'Nouvelle variante',
    'no_variants': 'Aucune variante',
    'create_first_variant': 'Créer la première variante',
    'variant_name': 'Nom de la variante',
    'variant_name_placeholder': 'Ex: Taille L, Rouge, 500ml...',
    'price_modifier': 'Modification de prix',
    'final_price': 'Prix final',
    'stock_tracked': 'Stock suivi',
    'confirm_delete_variant': 'Êtes-vous sûr de vouloir supprimer la variante "{name}" ? Cette action est irréversible.',
    'variant_translations': 'Traductions de la variante',
  },
  ar: {
    'products': 'المنتجات',
    'categories': 'الفئات',
    'dashboard': 'لوحة التحكم',
    'orders': 'الطلبات',
    'settings': 'الإعدادات',
    'reports': 'التقارير',
    'add_product': 'إضافة منتج',
    'edit_product': 'تعديل المنتج',
    'save': 'حفظ',
    'cancel': 'إلغاء',
    'delete': 'حذف',
    'search': 'بحث',
    'filter': 'تصفية',
    'name': 'الاسم',
    'price': 'السعر',
    'category': 'الفئة',
    'status': 'الحالة',
    'active': 'نشط',
    'inactive': 'غير نشط',
    'draft': 'مسودة',
    'available': 'متوفر',
    'unavailable': 'غير متوفر',
    'description': 'الوصف',
    'short_description': 'وصف قصير',
    'long_description': 'وصف طويل',
    'images': 'الصور',
    'variants': 'المتغيرات',
    'details': 'التفاصيل',
    'pricing': 'التسعير',
    'inventory': 'المخزون',
    'type': 'النوع',
    'simple': 'بسيط',
    'variable': 'متغير',
    'composite': 'مركب',
    'barcode': 'الباركود',
    'sku': 'رمز المنتج',
    'cost_price': 'سعر التكلفة',
    'brand': 'العلامة التجارية',
    'track_stock': 'تتبع المخزون',
    'printer_dest': 'الطابعة',
    'kitchen': 'المطبخ',
    'bar': 'البار',
    'oven': 'الفرن',
    'none': 'لا شيء',
    'all_categories': 'جميع الفئات',
    'all_statuses': 'جميع الحالات',
    'no_products': 'لم يتم العثور على منتجات',
    'no_categories': 'لم يتم العثور على فئات',
    'loading': 'جاري التحميل...',
    'error': 'خطأ',
    'success': 'نجاح',
    'confirm_delete': 'تأكيد الحذف',
    'language': 'اللغة',
    'translations': 'الترجمات',
    'add_translation': 'إضافة ترجمة',
    'edit_translation': 'تعديل الترجمة',
    'unsaved_changes': 'تغييرات غير محفوظة',
    'unsaved_changes_confirm': 'لديك تغييرات غير محفوظة. هل تريد المغادرة حقًا؟',
    // Dashboard
    'today_revenue': 'إيرادات اليوم',
    'today_orders': 'الطلبات',
    'avg_order': 'متوسط الطلب',
    'completion_rate': 'معدل الإنجاز',
    'vs_yesterday': 'مقارنة بالأمس',
    'completed': 'مكتملة',
    'pending': 'قيد الانتظار',
    'cancelled': 'ملغاة',
    'refresh': 'تحديث',
    'performance_today': 'أداء اليوم لـ',
    'your_restaurant': 'مطعمك',
    // Orders
    'order_number': 'الرقم',
    'date': 'التاريخ',
    'total': 'المجموع',
    'waiter': 'النادل',
    'actions': 'الإجراءات',
    'export_csv': 'تصدير CSV',
    'no_orders': 'لم يتم العثور على طلبات',
    'confirmed': 'مؤكد',
    'preparing': 'قيد التحضير',
    'ready': 'جاهز',
    'void': 'ملغى',
    'dine_in': 'في المكان',
    'takeaway': 'للأخذ',
    'delivery': 'توصيل',
    'page_of': 'صفحة {page} من {total}',
    'clear': 'مسح',
    // Sidebar
    'collapse': 'طي',
    // Header
    'owner': 'المالك',
    'logout': 'تسجيل الخروج',
    // Settings
    'general_settings': 'الإعدادات العامة',
    'store_info': 'معلومات المتجر',
    'notifications': 'الإشعارات',
    'security': 'الأمان',
    // New product
    'new_product': 'منتج جديد',
    'create_product': 'إنشاء منتج',
    'back': 'رجوع',
    // Common
    'found': 'تم العثور',
    'new_category': 'فئة جديدة',
    'create_category': 'إنشاء فئة',
    'edit_category': 'تعديل الفئة',
    'parent_category': 'الفئة الأم',
    'no_parent': 'بدون (فئة رئيسية)',
    'product_not_found': 'المنتج غير موجود',
    'product_variants': 'متغيرات المنتج',
    'images_updated': 'تم تحديث الصور',
    'title': 'العنوان',
    'select_category': 'اختر فئة',
    'cost_per_item': 'التكلفة لكل وحدة',
    'margin': 'الهامش',
    'profit': 'الربح',
    'track_quantity': 'تتبع الكمية',
    'manage_stock_levels': 'إدارة مستويات المخزون لهذا المنتج',
    'sku_label': 'SKU (وحدة حفظ المخزون)',
    'barcode_label': 'الباركود (ISBN, UPC, GTIN)',
    'brand_supplier': 'العلامة التجارية / المورد',
    'print_options': 'خيارات الطباعة',
    'print_destination': 'وجهة الطباعة',
    'print_destination_help': 'حدد أين سيتم إرسال أوامر الطلب',
    'organization': 'التنظيم',
    'product_type': 'نوع المنتج',
    'information': 'المعلومات',
    'created': 'تم الإنشاء',
    'modified': 'تم التعديل',
    'visible_catalog': 'مرئي في الكتالوج',
    'not_visible_customers': 'غير مرئي للعملاء',
    'media': 'الوسائط',
    'good_description_help': 'الوصف الجيد يساعد العملاء على فهم منتجك.',
    'leave_empty_fallback': 'اتركه فارغًا لاستخدام الوصف بـ{lang}.',
    'default': 'افتراضي',
    // Variants
    'add_variant': 'إضافة متغير',
    'edit_variant': 'تعديل المتغير',
    'delete_variant': 'حذف المتغير',
    'new_variant': 'متغير جديد',
    'no_variants': 'لا توجد متغيرات',
    'create_first_variant': 'إنشاء أول متغير',
    'variant_name': 'اسم المتغير',
    'variant_name_placeholder': 'مثال: حجم L، أحمر، 500مل...',
    'price_modifier': 'تعديل السعر',
    'final_price': 'السعر النهائي',
    'stock_tracked': 'المخزون متتبع',
    'confirm_delete_variant': 'هل أنت متأكد من حذف المتغير "{name}"؟ هذا الإجراء لا يمكن التراجع عنه.',
    'variant_translations': 'ترجمات المتغير',
  },
  en: {
    'products': 'Products',
    'categories': 'Categories',
    'dashboard': 'Dashboard',
    'orders': 'Orders',
    'settings': 'Settings',
    'reports': 'Reports',
    'add_product': 'Add Product',
    'edit_product': 'Edit Product',
    'save': 'Save',
    'cancel': 'Cancel',
    'delete': 'Delete',
    'search': 'Search',
    'filter': 'Filter',
    'name': 'Name',
    'price': 'Price',
    'category': 'Category',
    'status': 'Status',
    'active': 'Active',
    'inactive': 'Inactive',
    'draft': 'Draft',
    'available': 'Available',
    'unavailable': 'Unavailable',
    'description': 'Description',
    'short_description': 'Short Description',
    'long_description': 'Long Description',
    'images': 'Images',
    'variants': 'Variants',
    'details': 'Details',
    'pricing': 'Pricing',
    'inventory': 'Inventory',
    'type': 'Type',
    'simple': 'Simple',
    'variable': 'Variable',
    'composite': 'Composite',
    'barcode': 'Barcode',
    'sku': 'SKU',
    'cost_price': 'Cost Price',
    'brand': 'Brand',
    'track_stock': 'Track Stock',
    'printer_dest': 'Printer',
    'kitchen': 'Kitchen',
    'bar': 'Bar',
    'oven': 'Oven',
    'none': 'None',
    'all_categories': 'All Categories',
    'all_statuses': 'All Statuses',
    'no_products': 'No products found',
    'no_categories': 'No categories found',
    'loading': 'Loading...',
    'error': 'Error',
    'success': 'Success',
    'confirm_delete': 'Confirm Delete',
    'language': 'Language',
    'translations': 'Translations',
    'add_translation': 'Add Translation',
    'edit_translation': 'Edit Translation',
    'unsaved_changes': 'Unsaved changes',
    'unsaved_changes_confirm': 'You have unsaved changes. Are you sure you want to leave?',
    // Dashboard
    'today_revenue': 'Today\'s Revenue',
    'today_orders': 'Orders',
    'avg_order': 'Average Order',
    'completion_rate': 'Completion Rate',
    'vs_yesterday': 'vs yesterday',
    'completed': 'Completed',
    'pending': 'Pending',
    'cancelled': 'Cancelled',
    'refresh': 'Refresh',
    'performance_today': 'Today\'s performance for',
    'your_restaurant': 'your restaurant',
    // Orders
    'order_number': 'Number',
    'date': 'Date',
    'total': 'Total',
    'waiter': 'Waiter',
    'actions': 'Actions',
    'export_csv': 'Export CSV',
    'no_orders': 'No orders found',
    'confirmed': 'Confirmed',
    'preparing': 'Preparing',
    'ready': 'Ready',
    'void': 'Void',
    'dine_in': 'Dine In',
    'takeaway': 'Takeaway',
    'delivery': 'Delivery',
    'page_of': 'Page {page} of {total}',
    'clear': 'Clear',
    // Sidebar
    'collapse': 'Collapse',
    // Header
    'owner': 'Owner',
    'logout': 'Log out',
    // Settings
    'general_settings': 'General Settings',
    'store_info': 'Store Information',
    'notifications': 'Notifications',
    'security': 'Security',
    // New product
    'new_product': 'New Product',
    'create_product': 'Create Product',
    'back': 'Back',
    // Common
    'found': 'found',
    'new_category': 'New Category',
    'create_category': 'Create Category',
    'edit_category': 'Edit Category',
    'parent_category': 'Parent Category',
    'no_parent': 'None (root category)',
    'product_not_found': 'Product not found',
    'product_variants': 'Product Variants',
    'images_updated': 'Images updated',
    'title': 'Title',
    'select_category': 'Select a category',
    'cost_per_item': 'Cost per item',
    'margin': 'Margin',
    'profit': 'Profit',
    'track_quantity': 'Track quantity',
    'manage_stock_levels': 'Manage stock levels for this product',
    'sku_label': 'SKU (Stock Keeping Unit)',
    'barcode_label': 'Barcode (ISBN, UPC, GTIN)',
    'brand_supplier': 'Brand / Supplier',
    'print_options': 'Print Options',
    'print_destination': 'Print Destination',
    'print_destination_help': 'Select where order tickets will be sent',
    'organization': 'Organization',
    'product_type': 'Product Type',
    'information': 'Information',
    'created': 'Created',
    'modified': 'Modified',
    'visible_catalog': 'Visible in catalog',
    'not_visible_customers': 'Not visible to customers',
    'media': 'Media',
    'good_description_help': 'A good description helps customers understand your product.',
    'leave_empty_fallback': 'Leave empty to use the {lang} description.',
    'default': 'Default',
    // Variants
    'add_variant': 'Add variant',
    'edit_variant': 'Edit variant',
    'delete_variant': 'Delete variant',
    'new_variant': 'New variant',
    'no_variants': 'No variants',
    'create_first_variant': 'Create first variant',
    'variant_name': 'Variant name',
    'variant_name_placeholder': 'E.g.: Size L, Red, 500ml...',
    'price_modifier': 'Price modifier',
    'final_price': 'Final price',
    'stock_tracked': 'Stock tracked',
    'confirm_delete_variant': 'Are you sure you want to delete the variant "{name}"? This action cannot be undone.',
    'variant_translations': 'Variant translations',
  },
}

const LanguageContext = createContext<LanguageContextType | undefined>(undefined)

const STORAGE_KEY = 'sahara-admin-language'

export function LanguageProvider({ children }: { children: ReactNode }) {
  const [currentLanguage, setCurrentLanguage] = useState<LanguageCode>('fr')
  const [languages] = useState<Language[]>(defaultLanguages)

  // Load saved language preference
  useEffect(() => {
    const saved = localStorage.getItem(STORAGE_KEY)
    if (saved && ['fr', 'ar', 'en'].includes(saved)) {
      setCurrentLanguage(saved as LanguageCode)
    }
  }, [])

  // Update document direction for RTL languages
  useEffect(() => {
    const lang = languages.find(l => l.code === currentLanguage)
    if (lang) {
      document.documentElement.dir = lang.is_rtl ? 'rtl' : 'ltr'
      document.documentElement.lang = currentLanguage
    }
  }, [currentLanguage, languages])

  const setLanguage = useCallback((code: LanguageCode) => {
    setCurrentLanguage(code)
    localStorage.setItem(STORAGE_KEY, code)
  }, [])

  const t = useCallback((key: string): string => {
    return uiTranslations[currentLanguage]?.[key] || uiTranslations['fr'][key] || key
  }, [currentLanguage])

  const isRTL = languages.find(l => l.code === currentLanguage)?.is_rtl || false

  return (
    <LanguageContext.Provider value={{ currentLanguage, languages, isRTL, setLanguage, t }}>
      {children}
    </LanguageContext.Provider>
  )
}

export function useLanguage() {
  const context = useContext(LanguageContext)
  if (context === undefined) {
    throw new Error('useLanguage must be used within a LanguageProvider')
  }
  return context
}
